# Funcionalidad 7: Secciones de m√©tricas y visualizaci√≥n

## üìä Descripci√≥n General

La Funcionalidad 7 implementa un sistema completo de m√©tricas y visualizaci√≥n para la aplicaci√≥n FlowDiagram App, proporcionando tanto m√©tricas personales para usuarios como m√©tricas globales y an√°lisis para administradores. El sistema est√° dise√±ado para mejorar la comprensi√≥n de algoritmos mediante el seguimiento del progreso educativo y t√©cnico.

## ‚ú® Caracter√≠sticas Implementadas

### üéØ Para Usuarios Normales
- **M√©tricas Personales**: Seguimiento individual del progreso
- **Visualizaci√≥n de Progreso**: Gr√°ficos y estad√≠sticas de actividad
- **M√©tricas Educativas**: Tiempo de estudio, errores, pistas utilizadas
- **M√©tricas T√©cnicas**: Diagramas creados, validaciones, c√≥digo generado
- **Historial de Actividad**: Registro de √∫ltimas acciones realizadas

### üëë Para Administradores
- **Panel de Control Global**: Vista general del sistema
- **M√©tricas de Usuarios**: An√°lisis de todos los usuarios
- **Estad√≠sticas del Sistema**: Uso general de la aplicaci√≥n
- **Rankings y Tendencias**: Usuarios m√°s activos y patrones de uso
- **Recomendaciones**: Sugerencias basadas en datos del sistema

## üèóÔ∏è Arquitectura del Sistema

### Modelos de Datos

#### `MetricModel`
```dart
class MetricModel {
  final String id;
  final String name;
  final double value;
  final String unit;
  final String category;
  final DateTime lastUpdated;
  final Map<String, dynamic> metadata;
}
```

#### `MetricsSummary` 
```dart
class MetricsSummary {
  final int totalDiagrams;
  final int totalCodeGenerations;
  final int totalValidations;
  final int totalTemplatesUsed;
  final double averageTime;
  final double successRate;
  final DateTime lastActivity;
  final Map<String, dynamic> educationalMetrics;
  final Map<String, dynamic> technicalMetrics;
}
```

#### `GlobalMetrics`
```dart
class GlobalMetrics {
  final int totalUsers;
  final int activeUsers;
  final int totalDiagrams;
  final int totalValidations;
  final double averageUserProgress;
  final Map<String, int> usersByRole;
  final Map<String, double> performanceMetrics;
  final List<Map<String, dynamic>> topUsers;
  final DateTime generatedAt;
}
```

### Servicios

#### `MetricsService`
Servicio principal para el manejo de m√©tricas con las siguientes funcionalidades:
- **Seguimiento de acciones**: `trackUserAction()`
- **M√©tricas educativas**: `trackEducationalMetric()`
- **Resumen de usuario**: `getUserMetricsSummary()`
- **M√©tricas globales**: `getGlobalMetrics()` (solo admins)
- **Lista de usuarios**: `getUsersWithMetrics()` (solo admins)
- **Modo offline**: Soporte completo sin conexi√≥n

## üì± Interfaces de Usuario

### Pantalla de M√©tricas del Usuario (`MetricsScreen`)

**Ubicaci√≥n**: `lib/screens/metrics_screen.dart`

**Caracter√≠sticas**:
- Informaci√≥n del perfil del usuario
- M√©tricas t√©cnicas (diagramas, validaciones, c√≥digo)
- M√©tricas educativas (tiempo, errores, confianza)
- Gr√°fico de progreso visual
- Actividad reciente
- Acceso al panel de administrador (solo admins)

**Navegaci√≥n**:
- Desde el perfil del usuario
- Desde la pantalla principal (bot√≥n de m√©tricas)

### Panel de Administrador (`AdminMetricsScreen`)

**Ubicaci√≥n**: `lib/screens/admin_metrics_screen.dart`

**Caracter√≠sticas**:
- **Pesta√±a Resumen**: Vista general del sistema
  - Tarjetas de m√©tricas principales
  - Distribuci√≥n de usuarios por rol
  - M√©tricas de rendimiento
  - Informaci√≥n del sistema
  
- **Pesta√±a Usuarios**: An√°lisis detallado de usuarios
  - Lista expandible de todos los usuarios
  - M√©tricas individuales de cada usuario
  - Indicadores de rol (Usuario/Admin)
  - Estado de actividad
  
- **Pesta√±a An√°lisis**: An√°lisis avanzado
  - Top usuarios m√°s activos
  - Tendencias de uso
  - Recomendaciones del sistema

**Acceso**:
- Solo para usuarios con rol de administrador
- Verificaci√≥n autom√°tica de permisos
- Redirecci√≥n si no se tienen permisos

### Configuraci√≥n de Administrador (`AdminSetupScreen`)

**Ubicaci√≥n**: `lib/screens/admin_setup_screen.dart`

**Prop√≥sito**: Resolver problemas de configuraci√≥n inicial y permisos

**Funcionalidades**:
- Crear administrador por defecto
- Promover usuarios existentes a administrador
- Diagn√≥stico del estado actual
- Informaci√≥n de credenciales

**Credenciales de Admin por Defecto**:
- **Email**: `admin@flowdiagram.com`
- **Contrase√±a**: `Admin123456`

## üé® Widgets de Visualizaci√≥n

### `MetricsChartWidget`

**Ubicaci√≥n**: `lib/widgets/metrics_chart_widget.dart`

**Tipos de Gr√°ficos Soportados**:
- **Gr√°fico de Barras**: Para comparaciones
- **Gr√°fico de L√≠neas**: Para tendencias temporales  
- **Gr√°fico de Pastel**: Para distribuciones

**Widgets Adicionales**:
- `QuickStatsWidget`: Estad√≠sticas r√°pidas en chips
- `ComparisonWidget`: Comparaciones con barras de progreso

## üîß Integraci√≥n con la Aplicaci√≥n

### Seguimiento Autom√°tico de M√©tricas

Las m√©tricas se registran autom√°ticamente en las siguientes acciones:

#### En `EditorScreen`:
```dart
// Creaci√≥n de nodos
await _metricsService.trackUserAction(
  action: 'nodo_creado',
  category: 'technical',
  metadata: {'nodeType': nodeType.toString()},
);

// Validaci√≥n de diagramas
await _metricsService.trackUserAction(
  action: successful ? 'validacion_exitosa' : 'validacion_fallida',
  category: 'educational',
  metadata: {'errorsFound': result.errors.length},
);

// Generaci√≥n de c√≥digo
await _metricsService.trackUserAction(
  action: 'codigo_generado',
  category: 'technical',
  metadata: {'nodesCount': nodes.length},
);
```

#### En `LoadDiagramScreen`:
```dart
// Uso de plantillas
await _metricsService.trackUserAction(
  action: 'plantilla_usada',
  category: 'educational',
  metadata: {'templateName': template.name},
);
```

### Navegaci√≥n a M√©tricas

**Desde la Pantalla Principal**:
```dart
IconButton(
  icon: const Icon(Icons.analytics),
  onPressed: () {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => const MetricsScreen(),
      ),
    );
  },
  tooltip: 'Mis m√©tricas',
),
```

**Desde el Perfil**:
```dart
ElevatedButton.icon(
  onPressed: () {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => const MetricsScreen(),
      ),
    );
  },
  icon: const Icon(Icons.analytics),
  label: const Text('Ver Mis M√©tricas'),
),
```

## üîê Sistema de Permisos y Seguridad

### Verificaci√≥n de Administrador

```dart
void _checkAdminAccess() {
  final user = _authService.currentUser;
  if (user == null || !user.isAdmin) {
    Navigator.of(context).pop();
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('Acceso denegado: Solo administradores pueden ver esta secci√≥n'),
        backgroundColor: Colors.red,
      ),
    );
    return;
  }
  _loadAllMetrics();
}
```

### Manejo de Errores de Permisos

```dart
try {
  final globalMetrics = await _metricsService.getGlobalMetrics();
  // Procesar m√©tricas...
} catch (e) {
  if (e.toString().contains('permission-denied')) {
    // Usar m√©tricas por defecto
    return _createDefaultGlobalMetrics();
  }
  throw Exception('Error obteniendo m√©tricas globales: ${e.toString()}');
}
```

## üìä Almacenamiento de Datos

### Firebase Firestore
- **Colecci√≥n `users`**: M√©tricas por usuario
- **Colecci√≥n `global_metrics`**: M√©tricas agregadas del sistema
- **Documentos en tiempo real**: Actualizaciones autom√°ticas

### Modo Offline
- **Cache local**: M√©tricas almacenadas localmente
- **Sincronizaci√≥n autom√°tica**: Al recuperar conexi√≥n
- **Funcionalidad completa**: Sin dependencia de internet

## üõ†Ô∏è Configuraci√≥n e Instalaci√≥n

### Dependencias Requeridas

Agregar en `pubspec.yaml`:
```yaml
dependencies:
  fl_chart: ^0.68.0        # Para gr√°ficos y visualizaci√≥n
  firebase_core: ^2.27.0   # Core de Firebase
  firebase_auth: ^4.17.8   # Autenticaci√≥n
  cloud_firestore: ^4.15.8 # Base de datos
  connectivity_plus: ^5.0.2 # Detecci√≥n de conectividad
  intl: ^0.18.1            # Formateo de fechas
```

### Configuraci√≥n de Firebase

1. **Configurar proyecto en Firebase Console**
2. **Habilitar Authentication y Firestore**
3. **Configurar reglas de seguridad**:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Usuarios pueden leer/escribir sus propios datos
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Solo admins pueden acceder a m√©tricas globales
    match /global_metrics/{document} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
```

## üöÄ Uso y Flujo de Trabajo

### Para Usuarios Normales

1. **Iniciar sesi√≥n** en la aplicaci√≥n
2. **Usar el editor** para crear diagramas (m√©tricas se registran autom√°ticamente)
3. **Acceder a m√©tricas personales**:
   - Desde el perfil ‚Üí "Ver Mis M√©tricas"
   - Desde pantalla principal ‚Üí bot√≥n de an√°lisis
4. **Revisar progreso** en gr√°ficos y estad√≠sticas

### Para Administradores

1. **Configurar administrador** (primera vez):
   - Usar bot√≥n de configuraci√≥n de admin (escudo)
   - Crear admin por defecto o promover usuario existente
2. **Acceder al panel de administrador**:
   - Desde m√©tricas personales ‚Üí "Ver M√©tricas Globales"
   - Desde perfil ‚Üí "Panel de Administrador"
3. **Analizar datos** en las tres pesta√±as disponibles

## üîß Soluci√≥n de Problemas Comunes

### Error "Null check operator used on a null value"

**Causa**: Uso de operador `!` en valores que pueden ser null

**Soluci√≥n**: Implementada verificaci√≥n segura de null
```dart
// ‚úÖ Correcto
final metrics = _globalMetrics;
if (metrics == null) return Center(child: Text('No hay datos disponibles'));

// ‚ùå Incorrecto  
_buildOverviewCards(_globalMetrics!)
```

### Error de permisos "Permission Denied"

**Causa**: Usuario no tiene permisos de administrador o reglas de Firestore

**Soluci√≥n**: 
1. Usar `AdminSetupScreen` para crear administrador
2. Verificar reglas de seguridad en Firestore
3. Sistema de respaldo con m√©tricas por defecto

### Error de navegaci√≥n

**Causa**: Uso de rutas nombradas sin configuraci√≥n

**Soluci√≥n**: Usar `MaterialPageRoute` directamente
```dart
Navigator.of(context).push(
  MaterialPageRoute(
    builder: (context) => const AdminMetricsScreen(),
  ),
);
```

## üìà M√©tricas Disponibles

### M√©tricas T√©cnicas
- **Diagramas creados**: Cantidad total de diagramas
- **C√≥digo generado**: Veces que se gener√≥ c√≥digo C
- **Validaciones realizadas**: Total de validaciones
- **Plantillas utilizadas**: Uso de plantillas predefinidas
- **Tiempo promedio**: Tiempo por sesi√≥n/actividad
- **Tasa de √©xito**: Porcentaje de validaciones exitosas

### M√©tricas Educativas
- **Ejercicios completados**: Tareas finalizadas
- **Tiempo total de estudio**: Minutos acumulados
- **Errores cometidos**: Cantidad de errores
- **Pistas utilizadas**: Ayudas solicitadas
- **Autoevaluaciones**: Niveles de confianza registrados
- **Progreso general**: Puntuaci√≥n calculada autom√°ticamente

### M√©tricas Globales (Solo Admins)
- **Total de usuarios**: Usuarios registrados en el sistema
- **Usuarios activos**: Actividad en per√≠odo reciente
- **Distribuci√≥n por roles**: Usuario vs Administrador
- **M√©tricas de rendimiento**: Promedios del sistema
- **Top usuarios**: Ranking de m√°s activos
- **Tendencias de uso**: Patrones temporales

## üéØ Beneficios Educativos

### Para Estudiantes
- **Autoconocimiento**: Visualizaci√≥n del progreso personal
- **Motivaci√≥n**: Gamificaci√≥n a trav√©s de m√©tricas
- **Identificaci√≥n de √°reas de mejora**: An√°lisis de errores y tiempo
- **Seguimiento temporal**: Evoluci√≥n del aprendizaje

### Para Educadores
- **Monitoreo grupal**: Vista global de la clase
- **Identificaci√≥n de dificultades**: An√°lisis de errores comunes
- **Personalizaci√≥n**: Adaptar ense√±anza seg√∫n m√©tricas
- **Evaluaci√≥n objetiva**: Datos cuantificables del progreso

## üîÆ Futuras Mejoras

### Visualizaciones Avanzadas
- Gr√°ficos de correlaci√≥n entre m√©tricas
- Heatmaps de actividad temporal
- Predicciones de progreso con ML

### M√©tricas Adicionales
- Tiempo de resoluci√≥n por tipo de problema
- Patrones de errores m√°s comunes
- Comparaci√≥n con promedios grupales

### Gamificaci√≥n
- Sistema de logros y badges
- Competencias entre usuarios
- Niveles de progreso

## üìÅ Estructura de Archivos

```
lib/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ metric_model.dart              # Modelos de datos de m√©tricas
‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îú‚îÄ‚îÄ metrics_screen.dart            # Pantalla de m√©tricas del usuario
‚îÇ   ‚îú‚îÄ‚îÄ admin_metrics_screen.dart      # Panel de administrador
‚îÇ   ‚îî‚îÄ‚îÄ admin_setup_screen.dart        # Configuraci√≥n de administrador
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ metrics_service.dart           # L√≥gica de negocio de m√©tricas
‚îî‚îÄ‚îÄ widgets/
    ‚îî‚îÄ‚îÄ metrics_chart_widget.dart      # Widgets de visualizaci√≥n

docs/
‚îî‚îÄ‚îÄ NULL_SAFETY_FIX_GUIDE.md          # Gu√≠a de soluci√≥n de problemas
```

## üèÜ Estado de Implementaci√≥n

- ‚úÖ **Modelos de datos**: Completamente implementados
- ‚úÖ **Servicios de m√©tricas**: Funcionales con modo offline
- ‚úÖ **Pantallas de usuario**: M√©tricas personales completas
- ‚úÖ **Panel de administrador**: Tres pesta√±as funcionales
- ‚úÖ **Widgets de visualizaci√≥n**: Gr√°ficos implementados
- ‚úÖ **Integraci√≥n autom√°tica**: Seguimiento en tiempo real
- ‚úÖ **Sistema de permisos**: Verificaci√≥n robusta
- ‚úÖ **Manejo de errores**: Null safety y fallbacks
- ‚úÖ **Documentaci√≥n**: Gu√≠as completas

## üë• Contribuci√≥n

Para contribuir a esta funcionalidad:

1. **Revisar la documentaci√≥n** de soluci√≥n de problemas
2. **Seguir las buenas pr√°cticas** de null safety
3. **Probar en modo offline** para asegurar funcionamiento
4. **Verificar permisos** antes de implementar nuevas caracter√≠sticas
5. **Documentar cambios** en los archivos README correspondientes

---

*Funcionalidad 7 desarrollada como parte del Proyecto Final de Desarrollo de Aplicaciones M√≥viles Nativas - FlowDiagram App*
